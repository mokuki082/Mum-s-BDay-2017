<!DOCTYPE HTML>
<html>
    <head>
        <script src='js/jquery-2.1.3.min.js'></script>
        <script src='js/jquery.easing.1.3.js'></script>
    </head>
    <body>

        <div id='container'><span id="clickAnywhere">滑鼠點擊窗口任一地點</span></div>

        <script type='text/javascript'>

            var main = function() {
                var phrase = "HAPPY BIRTHDAY MUM";

                // Generate ball objects
                function init() {
                    // Generate a list of balls
                    var spacesEncountered = 0;

                    var randomRGB = function(low=0, high=256) {
                        return Math.round(Math.random() * (high-low) + low);
                    }

                    for (var i = 0; i < phrase.length; i++) {
                        if (phrase[i] == " ") {
                            spacesEncountered++;
                            continue;
                        }
                        var ball = document.createElement("div");
                        ball.className = "ball";
                        ball.id = "ball" + (i - spacesEncountered);
                        ball.style.backgroundColor = "rgb(" + randomRGB(25,256) + ',' +
                                                            79 + ',' +
                                                            79 + ")";
                        var str = document.createTextNode(phrase[i]);
                        ball.appendChild(str);
                        document.getElementById("container").appendChild(ball);
                    }
                }

                // Ball Bouncing animation
                function ballBounce(ball) {
                    vInit = 0
                    acc = 0.001
                    dist = (window.innerHeight - 60) - ball.style.top.slice(0,-2);
                    var vFinal = Math.sqrt(vInit**2 + 2*acc*dist);
                    var time = Math.round((vFinal - vInit)/acc);

                    $(ball).animate({
                        top:"+=" + dist
                    }, time, "easeOutBounce", function() {
                        // if last ball is clicked, rearrange all balls
                        if (ballId == phrase.length - phrase.match(/\s/g).length) { // last ball
                            rearrangeBalls();
                        }
                    });
                }

                // Move individual ball to a specified xy coordinate
                function moveBall(ballId, x, y) {
                    $(document.getElementById('ball'+ballId)).animate({
                        left: x,
                        top: y
                    },500, "easeInQuad", function() {
                        // TODO: if ballId  == last ball: play sound & animation
                    });
                }

                // Rearrange balls into "Happy Birthday Mum"
                function rearrangeBalls() {
                    words = phrase.split(" ");
                    var containerHeight = document.getElementById("container").offsetHeight;
                    var containerWidth = document.getElementById("container").offsetWidth;
                    var lineHeight = containerHeight / words.length;
                    var ballId = 0;
                    var xs = []
                    var ys = []
                    for (i in words) {
                        for (j in words[i]) {
                            var x = j * 150 + (containerWidth - 8*150)/2;
                            var y = i * lineHeight + (lineHeight  - 120)/2;
                            moveBall(ballId, x, y);
                            ballId++;
                        }
                    }

                }

                // Make Balls appear at cursor position when clicked
                var ballId = 0;
                var clickAnywhere = document.getElementById("clickAnywhere");
                document.onclick = function() {
                    // Set click anywhere to hidden when first clicked
                    if (clickAnywhere.style.visibility != "hidden") {
                        clickAnywhere.style.visibility = "hidden";
                    }
                    if (ballId < phrase.length - phrase.match(/\s/g).length) {
                        var ball = document.getElementById('ball'+ballId);
                        // Pop Out Animation
                        ball.style.top = event.clientY + 'px';
                        ball.style.left = event.clientX + 'px';
                        $(ball).animate({
                            top:'-=60',
                            left:'-=60',
                            width:"+=120",
                            height:"+=120",
                            fontSize:"+=60"
                        },500, "easeOutQuad");
                        // Bounce animation
                        ballBounce(ball);
                        ballId++;
                    }
                }; // end document onclick


                init();
            }

            $(document).ready(main);


        </script>

        <style>

            * {
                margin: 0;
                padding: 0;
            }
            .ball {
                width: 0px;
                height: 0px;
                position:absolute;
                background: rgb(0,183,255);
                -moz-border-radius: 60px;
                -webkit-border-radius: 60px;
                border-radius: 60px;
                font-size: 0px;
                text-align: center;
                color:white;
                vertical-align: top;
                line-height:120px;
                top:0;
                left:0;
            }

            #container {
                width: 100%;
                height:100%;
                display:block;
                position: absolute;
                background-color: rgb(203,176,142);
            }

            #clickAnywhere {
                width:20%;
                height:10%;
                top:45%;
                left:40%;
                display:block;
                position:absolute;
                color:#FFFFFF;
                font-family: monospace;
                font-size:15px;
                line-height:10%;
                text-align: center;

            }
        </style>
    </body>

</html>
